<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="User">

    <resultMap id="userResultMap" type="userVO">
        <result property="userId" column="user_id" />
        <result property="studyId" column="study_id" />
        <result property="userNumber" column="user_number" />
        <result property="userName" column="user_name" />
        <result property="userGoogleId" column="user_googleid" />
        <result property="userEmail" column="user_email" />
        <result property="userSolvedProblem" column="user_solvedproblem" />
        <result property="userParticipant" column="user_isparticipant" />
        <result property="userLeader" column="user_leader" />
    </resultMap>

    <resultMap id="LevelCountResultMap" type="LevelCountDTO">
        <result property="codeLevel" column="code_level" />
        <result property="solvedCount" column="solved_count" />
    </resultMap>

    <resultMap id="codeResult" type="codeVO">
        <result property="codeSolvedDate" column="code_solvedate" />
        <result property="codeTitle" column="code_title" />
        <result property="codeLevel" column="code_level" />
        <result property="codeSolvedTime" column="code_solvedtime" />
    </resultMap>

    <resultMap id="TokenResultMap" type="tokenVO">
        <result property="userId" column="user_id" />
        <result property="accessToken" column="access_token" />
        <result property="expirationTime" column="expiration_time" />
    </resultMap>

    <select id="findUser" parameterType="java.lang.String" resultMap="userResultMap">
        SELECT * FROM USERS
        WHERE user_googleid = #{number}
    </select>

    <insert id="save" parameterType="userVO">
        INSERT INTO USERS(user_id,
                          user_name,
                          user_googleid,
                          user_email
                          )
        VALUES (#{userId}, #{userName}, #{userGoogleId}, #{userEmail})
    </insert>

    <select id="finduserId" parameterType="java.lang.String" resultMap="userResultMap">
        SELECT *
            FROM users
        WHERE user_id = #{userId}
    </select>

    <select id="findToken" parameterType="java.lang.String" resultMap="TokenResultMap">
        SELECT *
        FROM TOKEN
        WHERE user_id = #{userId}
    </select>

    <insert id="saveToken" parameterType="tokenVO">
        INSERT INTO TOKEN(user_id,
                          access_token,
                          expiration_time
        )
        VALUES (#{userId}, #{accessToken}, #{expirationTime})
    </insert>

    <select id="solvedLevelsList" parameterType="java.lang.String" resultMap="LevelCountResultMap">
        SELECT c.code_level, COUNT(*) AS solved_count
        FROM USERS u JOIN CODE c ON (u.user_id = c.user_id)
        WHERE u.user_id = #{userId}
        GROUP BY c.code_level
        ORDER BY c.code_level
    </select>

    <select id="totalSolved" resultType="_int">
        SELECT user_solvedproblem
          FROM users
        WHERE user_id = #{userId}
    </select>

    <select id="solvedList" resultMap="codeResult">
        SELECT code_solvedate, code_title, code_level,code_solvedtime
        FROM code
        where user_id = #{userId};
    </select>

</mapper>
